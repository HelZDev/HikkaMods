# meta developer: its_Helz 
from .. import loader, utils
import os

class AutoReplyMod(loader.Module):
    """–ê–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫ –¥–ª—è Hikka —Å –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π"""
    
    strings = {
        "name": "AutoReply",
        "enabled": "‚úÖ –ê–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫ –≤–∫–ª—é—á—ë–Ω",
        "disabled": "‚ùå –ê–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫ –≤—ã–∫–ª—é—á–µ–Ω",
        "reply_set": "‚úçÔ∏è –°–æ–æ–±—â–µ–Ω–∏–µ –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ",
        "image_set": "üñº –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ",
        "no_image": "‚ö†Ô∏è –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è",
    }
    
    async def client_ready(self, client, db):
        self.db = db
        self.reply_enabled = self.db.get("AutoReply", "enabled", False)
        self.reply_text = self.db.get("AutoReply", "reply_text", "–ü—Ä–∏–≤–µ—Ç! –Ø —Å–µ–π—á–∞—Å –Ω–µ –≤ —Å–µ—Ç–∏.")
        self.image_path = self.db.get("AutoReply", "image_path", None)
        
    async def artogglecmd(self, message):
        """–í–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫"""
        self.reply_enabled = not self.reply_enabled
        self.db.set("AutoReply", "enabled", self.reply_enabled)
        await utils.answer(message, self.strings["enabled"] if self.reply_enabled else self.strings["disabled"])

    async def arsetcmd(self, message):
        """–ó–∞–¥–∞–µ—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫–∞"""
        text = utils.get_args_raw(message)
        if not text:
            return await utils.answer(message, "‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—Å—Ç –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞!")
        
        self.reply_text = text
        self.db.set("AutoReply", "reply_text", text)
        await utils.answer(message, self.strings["reply_set"])

    async def arimagecmd(self, message):
        """–ó–∞–¥–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫–∞"""
        reply = await message.get_reply_message()
        if not reply or not reply.media:
            return await utils.answer(message, self.strings["no_image"])
        
        file_path = f"{os.getcwd()}/auto_reply.jpg"
        await reply.download_media(file_path)
        self.image_path = file_path
        self.db.set("AutoReply", "image_path", file_path)
        await utils.answer(message, self.strings["image_set"])

    async def watcher(self, message):
        """–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—Ç–≤–µ—á–∞–µ—Ç, –µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫"""
        if message.is_private and not message.out and self.reply_enabled:
            lang = await self.get_lang()
            reply_text = self.get_localized_reply(lang)
            if self.image_path and os.path.exists(self.image_path):
                await message.client.send_file(message.chat_id, self.image_path, caption=reply_text)
            else:
                await message.reply(reply_text)

    async def get_lang(self):
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —è–∑—ã–∫ Hikka"""
        lang = self.db.get("hikka.lang", "lang_code", "ru")  # –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä—É—Å—Å–∫–∏–π
        return lang

    def get_localized_reply(self, lang):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç"""
        translations = {
            "ru": self.reply_text,
            "en": "Hello! I'm currently unavailable.",
            "es": "¬°Hola! No estoy disponible en este momento.",
            "fr": "Bonjour ! Je ne suis pas disponible pour le moment.",
            "de": "Hallo! Ich bin momentan nicht verf√ºgbar.",
            "zh": "‰Ω†Â•ΩÔºÅÊàëÁé∞Âú®‰∏çÂú®„ÄÇ",
        }
        return translations.get(lang, self.reply_text)
