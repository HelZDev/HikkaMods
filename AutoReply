# meta developer: —Ç–≤–æ–π_–Ω–∏–∫
from .. import loader, utils
import os
import time

class AutoReplyMod(loader.Module):
    """–ê–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫ –¥–ª—è –Ω–æ–≤—ã—Ö –õ–° —Å –∫—Ä–∞—Å–∏–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º"""

    strings = {
        "name": "AutoReply",
        "enabled": "‚úÖ –ê–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫ –≤–∫–ª—é—á—ë–Ω",
        "disabled": "‚ùå –ê–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫ –≤—ã–∫–ª—é—á–µ–Ω",
        "reply_set": "‚úçÔ∏è –°–æ–æ–±—â–µ–Ω–∏–µ –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ",
        "image_set": "üñº –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ",
        "no_image": "‚ö†Ô∏è –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è",
    }

    DEFAULT_MESSAGE = (
        "‚≠êÔ∏è *–°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ! (–ù–æ —Ö–æ–∑—è–∏–Ω –≤ offline...)*\n\n"
        "–ù–µ –≤–æ–ª–Ω—É–π—Ç–µ—Å—å! –í–ª–∞–¥–µ–ª–µ—Ü —Å–∫–æ—Ä–æ –≤–µ—Ä–Ω–µ—Ç—Å—è –≤ —Å–µ—Ç—å, –∞ –ø–æ–∫–∞‚Ä¶\n\n"
        "*–ß—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –±—ã—Å—Ç—Ä–µ–µ?*\n\n"
        "‚Ä¢ *1Ô∏è‚É£ –ó–∞–¥–∞–π—Ç–µ –±–æ–º–±–∏—á–µ—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å!*\n"
        "  ‚Ä¢ –ù–∞–ø–∏—à–∏—Ç–µ –µ–≥–æ –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ ‚Äì —Ç–∞–∫ –±—É–¥–µ—Ç –ø—Ä–æ—â–µ –ø–æ–Ω—è—Ç—å, —á—Ç–æ –≤–∞–º –Ω—É–∂–Ω–æ!\n\n"
        "‚Ä¢ *2Ô∏è‚É£ –ü–æ–∫–æ–ø–∞–π—Ç–µ—Å—å –≤ –≤–æ–ª—à–µ–±–Ω–æ–π –∫–Ω–∏–≥–µ FAQ!*\n"
        "  ‚Ä¢ –¢–∞–º –º–æ–≥—É—Ç –±—ã—Ç—å –æ—Ç–≤–µ—Ç—ã –Ω–∞ —Å–∞–º—ã–µ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã ‚Äì –ø–æ–ø—Ä–æ–±—É–π—Ç–µ, —ç—Ç–æ —Å—ç–∫–æ–Ω–æ–º–∏—Ç –≤–∞–º –≤—Ä–µ–º—è!\n\n"
        "‚Ä¢ *3Ô∏è‚É£ –ü—Ä–æ—Å—Ç–æ —á–∏–ª—å—Ç–µ –∏ –∂–¥–∏—Ç–µ!*\n"
        "  ‚Ä¢ –í–∞—à –∑–∞–ø—Ä–æ—Å –æ—á–µ–Ω—å –≤–∞–∂–µ–Ω, –∏ –æ—Ç–≤–µ—Ç –Ω–µ –∑–∞—Å—Ç–∞–≤–∏—Ç —Å–µ–±—è –∂–¥–∞—Ç—å!\n\n"
        "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à–µ —Ç–µ—Ä–ø–µ–Ω–∏–µ! ‚ù§Ô∏è\n\n"
        "_P.S. –ï—Å–ª–∏ –≤–¥—Ä—É–≥ —Ä–µ—à–∏—Ç–µ –ø–æ—Ä–∞–¥–æ–≤–∞—Ç—å –ø–æ–¥–∞—Ä–∫–æ–º –≤ Telegram, —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ —É–≤–µ–ª–∏—á–∏—Ç—Å—è –≤ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏!_"
    )

    DEFAULT_IMAGE_URL = "https://raw.githubusercontent.com/HelZDev/media-files/refs/heads/main/IMG_20250323_023021_126.jpg"

    REPLY_TIMEOUT = 3600  # 1 —á–∞—Å (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)

    async def client_ready(self, client, db):
        self.db = db
        self.reply_enabled = self.db.get("AutoReply", "enabled", False)
        self.reply_text = self.db.get("AutoReply", "reply_text", self.DEFAULT_MESSAGE)
        self.image_path = self.db.get("AutoReply", "image_path", None)
        self.replied_chats = self.db.get("AutoReply", "replied_chats", {})

    async def artogglecmd(self, message):
        """–í–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫"""
        self.reply_enabled = not self.reply_enabled
        self.db.set("AutoReply", "enabled", self.reply_enabled)
        await utils.answer(message, self.strings["enabled"] if self.reply_enabled else self.strings["disabled"])

    async def arsetcmd(self, message):
        """–ó–∞–¥–∞–µ—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫–∞"""
        reply = await message.get_reply_message()
        text = utils.get_args_raw(message) or (reply.text if reply and reply.text else None)
        
        if not text:
            return await utils.answer(message, "‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—Å—Ç –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞ –∏–ª–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ!")
        
        self.reply_text = text
        self.db.set("AutoReply", "reply_text", text)
        await utils.answer(message, self.strings["reply_set"])

    async def arimagecmd(self, message):
        """–ó–∞–¥–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫–∞"""
        reply = await message.get_reply_message()
        if not reply or not reply.media:
            return await utils.answer(message, self.strings["no_image"])

        file_path = f"{os.getcwd()}/auto_reply.jpg"
        await reply.download_media(file_path)
        self.image_path = file_path
        self.db.set("AutoReply", "image_path", file_path)
        await utils.answer(message, self.strings["image_set"])

    async def watcher(self, message):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç –≤ –Ω–æ–≤—ã—Ö –õ–° (–∫—Ä–æ–º–µ –±–æ—Ç–æ–≤) –æ–¥–∏–Ω —Ä–∞–∑, —Å–±—Ä–∞—Å—ã–≤–∞—è —Å–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ —á–∞—Å"""
        if not self.reply_enabled or not message.is_private or message.out:
            return

        user = await message.get_sender()
        if user.bot:
            return  # –ù–µ –æ—Ç–≤–µ—á–∞–µ–º –±–æ—Ç–∞–º

        user_id = message.chat_id
        current_time = time.time()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–æ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
        last_reply_time = self.replied_chats.get(user_id, 0)
        if current_time - last_reply_time < self.REPLY_TIMEOUT:
            return  # –ï—Å–ª–∏ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –ø—Ä–æ—à–ª–æ –º–µ–Ω—å—à–µ —á–∞—Å–∞, –Ω–µ –æ—Ç–≤–µ—á–∞–µ–º

        reply_text = self.reply_text
        image = self.image_path if self.image_path else self.DEFAULT_IMAGE_URL

        await message.client.send_file(user_id, image, caption=reply_text, force_document=False, parse_mode="MarkdownV2")

        # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ—Ç–≤–µ—Ç–∞
        self.replied_chats[user_id] = current_time
        self.db.set("AutoReply", "replied_chats", self.replied_chats)
