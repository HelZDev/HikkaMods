from .. import loader, utils
import re
import asyncio

class BonusBotMod(loader.Module):
    """ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð±Ð¾Ð½ÑƒÑÐ¾Ð² Ð² Telegram-Ð±Ð¾Ñ‚Ðµ"""
    strings = {"name": "BonusBot"}
    
    def __init__(self):
        self.running = False
        self.bot_username = "@gram_farm_bot"
    
    async def client_ready(self, client, db):
        self.client = client
    
    async def gfcmd(self, message):
        """Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ ÑÐ±Ð¾Ñ€Ð° Ð±Ð¾Ð½ÑƒÑÐ¾Ð²"""
        if self.running:
            await utils.answer(message, "âœ… Ð‘Ð¾Ñ‚ ÑƒÐ¶Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!")
            return
        self.running = True
        await utils.answer(message, "âœ… ÐÐ²Ñ‚Ð¾-ÑÐ±Ð¾Ñ€ Ð±Ð¾Ð½ÑƒÑÐ¾Ð² Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!")
        while self.running:
            await self.collect_bonus()
            await asyncio.sleep(86400)  # Ð—Ð°Ð¿ÑƒÑÐº Ñ€Ð°Ð· Ð² Ñ… Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
    
    async def gscmd(self, message):
        """ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ ÑÐ±Ð¾Ñ€Ð° Ð±Ð¾Ð½ÑƒÑÐ¾Ð²"""
        self.running = False
        await utils.answer(message, "ðŸ›‘ ÐÐ²Ñ‚Ð¾-ÑÐ±Ð¾Ñ€ Ð±Ð¾Ð½ÑƒÑÐ¾Ð² Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½!")
    
    async def bonuscmd(self, message):
        """Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð±Ð¾Ð½ÑƒÑÐ° Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ"""
        await self.client.send_message(self.bot_username, "ðŸŽ Ð‘Ð¾Ð½ÑƒÑ")
    
    async def watcher(self, message):
        if not message.sender_id:
            return
        
        if message.chat_id != (await self.client.get_entity(self.bot_username)).id:
            return
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° ÐºÐ°Ð¿Ñ‡Ñƒ (Ð¿Ð¾Ð¸ÑÐº Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð°)
        match = re.search(r"(\d+) \+ (\d+) =", message.text)
        if match:
            num1, num2 = map(int, match.groups())
            answer = num1 + num2
            await message.respond(str(answer))
            return
        
        # ÐŸÐ¾Ð¸ÑÐº ÐºÐ½Ð¾Ð¿ÐºÐ¸ "ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð±Ð¾Ð½ÑƒÑ"
        messages = await self.client.get_messages(self.bot_username, limit=1)
        if messages and messages[0].reply_markup:
            await messages[0].click(0)
            await asyncio.sleep(3)
    
    async def collect_bonus(self):
        await self.client.send_message(self.bot_username, "ðŸŽ Ð‘Ð¾Ð½ÑƒÑ")
        await asyncio.sleep(5)
        
        async for message in self.client.iter_messages(self.bot_username, limit=5):
            if "?" in message.text:
                answer = self.solve_captcha(message.text)
                if answer:
                    await message.reply(answer)
                    break
        
        await asyncio.sleep(5)
        
        messages = await self.client.get_messages(self.bot_username, limit=1)
        if messages and messages[0].reply_markup:
            await messages[0].click(0)
            await asyncio.sleep(3)
    
    def solve_captcha(self, text: str) -> str:
        match = re.search(r"(\d+) \+ (\d+)", text)
        return str(int(match.group(1)) + int(match.group(2))) if match else ""
