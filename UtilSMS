from .. import loader
import asyncio

#meta developer: @Novichok_v_Crypto

class MassSender(loader.Module):
    """ğŸ“¢ ĞœĞ°ÑÑĞ¾Ğ²Ğ°Ñ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ¿Ğ¾ Ñ‡Ğ°Ñ‚Ğ°Ğ¼."""

    strings = {"name": "MassSender"}

    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        self.chats = db.get(self.strings["name"], "chats", [])

    async def addchatcmd(self, message):
        """â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ñ‡Ğ°Ñ‚"""
        chat_id = message.chat_id
        if chat_id not in self.chats:
            self.chats.append(chat_id)
            self.db.set(self.strings["name"], "chats", self.chats)
            await message.edit("âœ… Ğ§Ğ°Ñ‚ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½.")
        else:
            await message.edit("âš ï¸ Ğ£Ğ¶Ğµ Ğ² ÑĞ¿Ğ¸ÑĞºĞµ.")

    async def delchatcmd(self, message):
        """â– Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ñ‡Ğ°Ñ‚"""
        chat_id = message.chat_id
        if chat_id in self.chats:
            self.chats.remove(chat_id)
            self.db.set(self.strings["name"], "chats", self.chats)
            await message.edit("âœ… Ğ§Ğ°Ñ‚ ÑƒĞ´Ğ°Ğ»Ñ‘Ğ½.")
        else:
            await message.edit("âš ï¸ Ğ§Ğ°Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.")

    async def chatscmd(self, message):
        """ğŸ“œ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‡Ğ°Ñ‚Ğ¾Ğ²"""
        if not self.chats:
            return await message.edit("ğŸ“­ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿ÑƒÑÑ‚.")
        chat_list = "\n".join([f"{chat}" for chat in self.chats])
        await message.edit(f"ğŸ“œ Ğ§Ğ°Ñ‚Ñ‹:\n{chat_list}")

    async def sendcmd(self, message):
        """ğŸ“© ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ (Ñ€ĞµĞ¿Ğ»Ğ°Ğ¹ Ğ¸Ğ»Ğ¸ Ñ‚ĞµĞºÑÑ‚ Ñ Ğ¼ĞµĞ´Ğ¸Ğ°) Ñ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ğ¾Ğ¼ Ğ¸ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ĞµĞ½Ğ¸ĞµĞ¼"""
        args = message.raw_text.split()
        reply = await message.get_reply_message()
        text = " ".join(args[1:]) if len(args) > 1 else None
        media = reply.media if reply and reply.media else None
        
        delay = 0
        repeat = 1
        
        if len(args) > 2 and args[-2].isdigit() and args[-1].isdigit():
            delay = int(args[-2])
            repeat = int(args[-1])
            text = " ".join(args[1:-2]) if len(args) > 3 else None
        
        if not reply and not text:
            return await message.edit("âš ï¸ Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ñ‚ĞµĞºÑÑ‚ Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑŒÑ‚Ğµ Ğ½Ğ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ.")

        count = 0
        for _ in range(repeat):
            for chat in self.chats:
                try:
                    if media:
                        await self.client.send_file(chat, media, caption=text if text else reply.text)
                    else:
                        await self.client.send_message(chat, text if text else reply.text)
                    count += 1
                except Exception:
                    pass
            if delay > 0 and _ < repeat - 1:
                await asyncio.sleep(delay)
        
        await message.edit(f"âœ… ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ² {count} Ñ‡Ğ°Ñ‚Ğ¾Ğ² {repeat} Ñ€Ğ°Ğ· Ñ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹ {delay} ÑĞµĞº.")

    async def addallcmd(self, message):
        """ğŸ“¥ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ñ‡Ğ°Ñ‚Ñ‹"""
        dialogs = await self.client.get_dialogs()
        self.chats = [dialog.id for dialog in dialogs if dialog.is_group or dialog.is_channel or dialog.is_user]
        self.db.set(self.strings["name"], "chats", self.chats)
        await message.edit(f"âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ {len(self.chats)} Ñ‡Ğ°Ñ‚Ğ¾Ğ².")

    async def clearcmd(self, message):
        """ğŸ—‘ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ‡Ğ°Ñ‚Ğ¾Ğ²"""
        self.chats = []
        self.db.set(self.strings["name"], "chats", self.chats)
        await message.edit("ğŸ—‘ Ğ§Ğ°Ñ‚Ñ‹ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ñ‹.")
