from hikkatl import loader, utils
import asyncio

class GramFarmBot(loader.Module):
    """–ê–≤—Ç–æ—Ñ–∞—Ä–º –±–æ–Ω—É—Å–æ–≤ –≤ @gram_farm_bot"""
    strings = {"name": "GramFarmBot"}
    
    def __init__(self):
        self.config = loader.ModuleConfig("BOT_USERNAME", "@gram_farm_bot", "–Æ–∑–µ—Ä–Ω–µ–π–º –±–æ—Ç–∞")
        self.running = False
        self.total_earned = 0

    async def goncmd(self, message):
        """–í–∫–ª—é—á–∞–µ—Ç –∞–≤—Ç–æ—Ñ–∞—Ä–º–∏–Ω–≥"""
        if self.running:
            await message.edit("<b>–§–∞—Ä–º —É–∂–µ –≤–∫–ª—é—á–µ–Ω!</b>")
            return

        self.running = True
        self.total_earned = 0
        await message.edit("<b>–ê–≤—Ç–æ—Ñ–∞—Ä–º –∑–∞–ø—É—â–µ–Ω!</b>")
        
        while self.running:
            await self._collect_bonus(message)

    async def goffcmd(self, message):
        """–í—ã–∫–ª—é—á–∞–µ—Ç –∞–≤—Ç–æ—Ñ–∞—Ä–º–∏–Ω–≥"""
        self.running = False
        await message.edit("<b>–ê–≤—Ç–æ—Ñ–∞—Ä–º –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!</b>")

    async def gfarmcmd(self, message):
        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å, –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Å –º–æ–º–µ–Ω—Ç–∞ –≤–∫–ª—é—á–µ–Ω–∏—è"""
        await message.edit(f"<b>–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: {self.total_earned} GRAM</b>")

    async def _collect_bonus(self, message):
        """–ú–µ—Ç–æ–¥ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±–æ—Ä–∞ –±–æ–Ω—É—Å–æ–≤"""
        try:
            await message.client.send_message(self.config["BOT_USERNAME"], "üéÅ –ë–æ–Ω—É—Å")
            await asyncio.sleep(5)  # –ñ–¥–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –±–æ—Ç–∞

            async for msg in message.client.iter_messages(self.config["BOT_USERNAME"], limit=5):
                if "–í—ã –ø–æ–ª—É—á–∏–ª–∏" in msg.text:
                    earned = int(msg.text.split("+")[1].split()[0])
                    self.total_earned += earned
                    await message.client.send_message(message.chat_id, f"<b>–ü–æ–ª—É—á–µ–Ω–æ: {earned} GRAM</b>")
                    await asyncio.sleep(86400)  # –ñ–¥–µ–º 24 —á–∞—Å–∞ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –±–æ–Ω—É—Å–∞
                    return
                
            await message.client.send_message(message.chat_id, "<b>–ë–æ–Ω—É—Å –Ω–µ –±—ã–ª –ø–æ–ª—É—á–µ–Ω. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω –µ—â–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.</b>")
            await asyncio.sleep(3600)  # –ü—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ 1 —á–∞—Å

        except Exception as e:
            await message.client.send_message(message.chat_id, f"<b>–û—à–∏–±–∫–∞: {e}</b>")
            await asyncio.sleep(3600)  # –ü—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ 1 —á–∞—Å
